<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js"></script>
<script>
(async function(){
  // --- Config: contract addresses ---
  const guestbookAddress = "0xcec8f80F70fCD4F97AF0874AE81B92dFbd9cCA2E";
  const simpleVotingAddress = "0x593393079914635026344565312224f8c8282e4F";
  const badgeScoreAddress = "0x7A38eBEf85D752Cc3CE8AdAC236243CBd3734e75";

  // --- ABIs (same as before, shortened here for clarity) ---
  const guestbookAbi = [
    "function sign(string message) external",
    "function totalEntries() view returns (uint256)",
    "function entryAt(uint256) view returns (address,uint256,string)"
  ];
  const simpleVotingAbi = [
    "function createProposal(string,string,uint256) external returns (uint256)",
    "function vote(uint256,bool) external",
    "function proposalSummary(uint256) view returns (uint256,string,string,uint256,uint256,uint256,uint256)",
    "function hasVoted(uint256,address) view returns (bool)"
  ];
  const badgeScoreAbi = [
    "function scoreOf(uint256) view returns (uint256)",
    "function increaseScore(uint256,uint256) external",
    "function badgeThreshold() view returns (uint256)",
    "function nextTokenId() view returns (uint256)",
    "function ownerOf(uint256) view returns (address)",
    "function tokenURI(uint256) view returns (string)",
    "function balanceOf(address) view returns (uint256)"
  ];

  // --- State ---
  let provider, signer, account;
  let guestbookContract, votingContract, badgeContract;

  // --- Helpers ---
  function log(msg) {
    const el = document.getElementById('logs');
    const now = new Date().toLocaleTimeString();
    el.innerHTML = `<div>[${now}] ${msg}</div>` + el.innerHTML;
  }
  function setText(id, txt) { document.getElementById(id).innerText = txt; }

  // --- Connect Wallet ---
  document.getElementById('connectBtn').onclick = async () => {
    if (!window.ethereum) return alert('Install MetaMask or another wallet.');
    try {
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []); // request once
      signer = await provider.getSigner();
      account = await signer.getAddress();
      document.getElementById('acct').innerText = account;
      log("Connected: " + account);

      // chain info
      const network = await provider.getNetwork();
      document.getElementById('chainInfo').innerText =
        `Network: ${network.name} (chainId ${network.chainId})`;

      // signer-bound contracts
      guestbookContract = new ethers.Contract(guestbookAddress, guestbookAbi, signer);
      votingContract = new ethers.Contract(simpleVotingAddress, simpleVotingAbi, signer);
      badgeContract = new ethers.Contract(badgeScoreAddress, badgeScoreAbi, signer);

      // do initial refresh
      refreshGuestbookCount();
      refreshMyBadges();
    } catch (err) {
      console.error(err);
      alert("Wallet connection failed: " + (err.message || err));
    }
  };

  // --- Before any action, check wallet ---
  function requireWallet() {
    if (!signer || !account) {
      alert("Please connect your wallet first");
      return false;
    }
    return true;
  }

  // Example use inside Guestbook
  document.getElementById('gbSignBtn').onclick = async () => {
    if (!requireWallet()) return;
    const text = document.getElementById('gbMsg').value;
    try {
      const tx = await guestbookContract.sign(text);
      await tx.wait();
      log("Signed Guestbook: " + text);
    } catch (err) {
      log("Error: " + (err.message || err));
    }
  };

  // The same requireWallet() check should wrap ALL other button handlers
  // (vote, createProposal, increaseScore, etc.)
  // That way they never call eth_requestAccounts again, only the first connect button does.
})();
</script>
